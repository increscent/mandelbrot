<!doctype html>

<html>
	<head>
		<meta charset="utf-8"/>
	</head>

	<body style="margin: 0; padding: 0;">
		<canvas id="canvas" width="800" height="800"></canvas>

		<script type="text/javascript">
			var canvas = document.getElementById('canvas');
			width = canvas.width;
			height = canvas.height;

			var initial_granularity = 200;
			var x_min = -1 * (width / initial_granularity / 2);
			var x_max = (width / initial_granularity / 2);
			var y_min = -1 * (height / initial_granularity / 2);
			var y_max = (height / initial_granularity / 2);

			var zoom_ratio = .05;
			var x_zoom_margin = zoom_ratio * width;
			var y_zoom_margin = zoom_ratio * height;

			var max_iterations = 100;

			var ctx = canvas.getContext('2d');

			drawMandelbrotSet();

			canvas.onwheel = (e) =>  {
				if (e.deltaY == 0)
					return;

				var zoom_direction = e.deltaY > 0 ? 1 : -1;

				var x_range = x_max - x_min;
				var y_range = y_max - y_min;

				var x_zoom = (x_zoom_margin / width) * x_range;
				var y_zoom = (y_zoom_margin / height) * y_range;

				var x_zoom_ratio = e.clientX / width;
				var y_zoom_ratio = e.clientY / height;

				x_min += (zoom_direction * x_zoom * x_zoom_ratio);
				x_max -= (zoom_direction * x_zoom * (1 - x_zoom_ratio));
				y_min += (zoom_direction * y_zoom * (1 - y_zoom_ratio));
				y_max -= (zoom_direction * y_zoom * y_zoom_ratio);

				drawMandelbrotSet();
			};

			function drawMandelbrotSet() {
				drawMandelbrot(ctx, width, height, x_min, x_max, y_min, y_max);
			}

			function drawMandelbrot(context, width, height, x_min, x_max, y_min, y_max) {
				var x_res = width / (x_max - x_min);
				var y_res = height / (y_max - y_min);

				var imageData = context.getImageData(0, 0, width, height);

				for (var i = height - 1; i >= 0; i--) {
					for (var j = 0; j < width; j++) {
						var cr = (j / x_res) + x_min;
						var ci = (i / y_res) + y_min;
						var zr = 0;
						var zi = 0;
						var z_tmp = 0;

						for (var k = 0; k < max_iterations; k++) {
							z_tmp = zr;
							zr = zr * zr - zi * zi + cr;
							zi = zi * z_tmp * 2 + ci;

							if (Math.sqrt(zr * zr + zi * zi) >= 2)
								break;
						}

						var index = ((height - 1 - i) * width + j) * 4;

						// only draw if in set
						if (k == max_iterations) {
							imageData.data[index] = 75;
							imageData.data[index + 1] = 66;
							imageData.data[index + 2] = 254;
							imageData.data[index + 3] = 255;
						} else if (k > max_iterations / 5) {
							imageData.data[index] = 66;
							imageData.data[index + 1] = 244;
							imageData.data[index + 2] = 78;
							imageData.data[index + 3] = 255;
						} else if (k > max_iterations / 50) {
							imageData.data[index] = 299;
							imageData.data[index + 1] = 244;
							imageData.data[index + 2] = 66;
							imageData.data[index + 3] = 255;
						} else {
							imageData.data[index] = 0;
							imageData.data[index + 1] = 0;
							imageData.data[index + 2] = 0;
							imageData.data[index + 3] = 0;
						}
					}
				}

				context.putImageData(imageData, 0, 0);
			}
		</script>
	</body>
</html>